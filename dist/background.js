/*! For license information please see background.js.LICENSE.txt */
(()=>{function t(e){return t="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},t(e)}function e(t,e){var n=Object.keys(t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(t);e&&(r=r.filter(function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable})),n.push.apply(n,r)}return n}function n(t){for(var n=1;n<arguments.length;n++){var a=null!=arguments[n]?arguments[n]:{};n%2?e(Object(a),!0).forEach(function(e){r(t,e,a[e])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(a)):e(Object(a)).forEach(function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(a,e))})}return t}function r(t,e,n){return(e=u(e))in t?Object.defineProperty(t,e,{value:n,enumerable:!0,configurable:!0,writable:!0}):t[e]=n,t}function a(){var t,e,n="function"==typeof Symbol?Symbol:{},r=n.iterator||"@@iterator",i=n.toStringTag||"@@toStringTag";function c(n,r,a,i){var c=r&&r.prototype instanceof u?r:u,h=Object.create(c.prototype);return o(h,"_invoke",function(n,r,a){var o,i,c,u=0,h=a||[],f=!1,l={p:0,n:0,v:t,a:p,f:p.bind(t,4),d:function(e,n){return o=e,i=0,c=t,l.n=n,s}};function p(n,r){for(i=n,c=r,e=0;!f&&u&&!a&&e<h.length;e++){var a,o=h[e],p=l.p,v=o[2];n>3?(a=v===r)&&(c=o[(i=o[4])?5:(i=3,3)],o[4]=o[5]=t):o[0]<=p&&((a=n<2&&p<o[1])?(i=0,l.v=r,l.n=o[1]):p<v&&(a=n<3||o[0]>r||r>v)&&(o[4]=n,o[5]=r,l.n=v,i=0))}if(a||n>1)return s;throw f=!0,r}return function(a,h,v){if(u>1)throw TypeError("Generator is already running");for(f&&1===h&&p(h,v),i=h,c=v;(e=i<2?t:c)||!f;){o||(i?i<3?(i>1&&(l.n=-1),p(i,c)):l.n=c:l.v=c);try{if(u=2,o){if(i||(a="next"),e=o[a]){if(!(e=e.call(o,c)))throw TypeError("iterator result is not an object");if(!e.done)return e;c=e.value,i<2&&(i=0)}else 1===i&&(e=o.return)&&e.call(o),i<2&&(c=TypeError("The iterator does not provide a '"+a+"' method"),i=1);o=t}else if((e=(f=l.n<0)?c:n.call(r,l))!==s)break}catch(e){o=t,i=1,c=e}finally{u=1}}return{value:e,done:f}}}(n,a,i),!0),h}var s={};function u(){}function h(){}function f(){}e=Object.getPrototypeOf;var l=[][r]?e(e([][r]())):(o(e={},r,function(){return this}),e),p=f.prototype=u.prototype=Object.create(l);function v(t){return Object.setPrototypeOf?Object.setPrototypeOf(t,f):(t.__proto__=f,o(t,i,"GeneratorFunction")),t.prototype=Object.create(p),t}return h.prototype=f,o(p,"constructor",f),o(f,"constructor",h),h.displayName="GeneratorFunction",o(f,i,"GeneratorFunction"),o(p),o(p,i,"Generator"),o(p,r,function(){return this}),o(p,"toString",function(){return"[object Generator]"}),(a=function(){return{w:c,m:v}})()}function o(t,e,n,r){var a=Object.defineProperty;try{a({},"",{})}catch(t){a=0}o=function(t,e,n,r){function i(e,n){o(t,e,function(t){return this._invoke(e,n,t)})}e?a?a(t,e,{value:n,enumerable:!r,configurable:!r,writable:!r}):t[e]=n:(i("next",0),i("throw",1),i("return",2))},o(t,e,n,r)}function i(t,e,n,r,a,o,i){try{var c=t[o](i),s=c.value}catch(t){return void n(t)}c.done?e(s):Promise.resolve(s).then(r,a)}function c(t){return function(){var e=this,n=arguments;return new Promise(function(r,a){var o=t.apply(e,n);function c(t){i(o,r,a,c,s,"next",t)}function s(t){i(o,r,a,c,s,"throw",t)}c(void 0)})}}function s(t,e){for(var n=0;n<e.length;n++){var r=e[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,u(r.key),r)}}function u(e){var n=function(e){if("object"!=t(e)||!e)return e;var n=e[Symbol.toPrimitive];if(void 0!==n){var r=n.call(e,"string");if("object"!=t(r))return r;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(e)}(e);return"symbol"==t(n)?n:n+""}var h=new(function(){return t=function t(e,n){!function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,t),this.baseURL=e||"http://localhost:4000/api/extension",this.authURL=n||"http://localhost:4000"},e=[{key:"checkAuthentication",value:(g=c(a().m(function t(){var e,n,r,o;return a().w(function(t){for(;;)switch(t.p=t.n){case 0:return t.n=1,this.getAuthData();case 1:if((e=t.v).auth_token){t.n=2;break}return t.a(2,{authenticated:!1,reason:"no_token"});case 2:if(!(e.expires_at&&new Date(e.expires_at)<new Date)){t.n=4;break}return t.n=3,this.clearAuthData();case 3:return t.a(2,{authenticated:!1,reason:"token_expired"});case 4:return t.p=4,t.n=5,fetch("".concat(this.authURL,"/api/is_authenticated"),{method:"GET",headers:{Authorization:"Bearer ".concat(e.auth_token),"Content-Type":"application/json"}});case 5:if(!(n=t.v).ok){t.n=11;break}return t.n=6,n.json();case 6:if(!(r=t.v).authenticated){t.n=8;break}return t.n=7,this.updateAuthData({last_check:(new Date).toISOString()});case 7:return t.a(2,{authenticated:!0,user:r.user});case 8:return t.n=9,this.clearAuthData();case 9:return t.a(2,{authenticated:!1,reason:"invalid_token"});case 10:t.n=13;break;case 11:return t.n=12,this.clearAuthData();case 12:return t.a(2,{authenticated:!1,reason:"server_error"});case 13:t.n=15;break;case 14:return t.p=14,o=t.v,console.error("Authentication check failed:",o),t.a(2,{authenticated:!1,reason:"network_error"});case 15:return t.a(2)}},t,this,[[4,14]])})),function(){return g.apply(this,arguments)})},{key:"getAuthData",value:(y=c(a().m(function t(){return a().w(function(t){for(;;)if(0===t.n)return t.a(2,new Promise(function(t){chrome.storage.local.get(["authData"],function(e){t(e.authData||{auth_token:"",user_id:"",expires_at:"",is_authenticated:!1,last_check:""})})}))},t)})),function(){return y.apply(this,arguments)})},{key:"setAuthData",value:(d=c(a().m(function t(e){return a().w(function(t){for(;;)if(0===t.n)return t.a(2,new Promise(function(t){chrome.storage.local.set({authData:e},t)}))},t)})),function(t){return d.apply(this,arguments)})},{key:"updateAuthData",value:(v=c(a().m(function t(e){var r,o;return a().w(function(t){for(;;)switch(t.n){case 0:return t.n=1,this.getAuthData();case 1:return r=t.v,o=n(n({},r),e),t.n=2,this.setAuthData(o);case 2:return t.a(2,o)}},t,this)})),function(t){return v.apply(this,arguments)})},{key:"clearAuthData",value:(p=c(a().m(function t(){return a().w(function(t){for(;;)if(0===t.n)return t.a(2,new Promise(function(t){chrome.storage.local.remove(["authData"],t)}))},t)})),function(){return p.apply(this,arguments)})},{key:"redirectToLogin",value:(l=c(a().m(function t(){return a().w(function(t){for(;;)switch(t.n){case 0:chrome.tabs.create({url:"".concat(this.authURL,"/users/log_in")});case 1:return t.a(2)}},t,this)})),function(){return l.apply(this,arguments)})},{key:"generateBrowserFingerprint",value:function(){var t={userAgent:navigator.userAgent,language:navigator.language,platform:navigator.platform,timezone:Intl.DateTimeFormat().resolvedOptions().timeZone};return btoa(JSON.stringify(t))}},{key:"getSessionToken",value:(f=c(a().m(function t(){var e=this;return a().w(function(t){for(;;)if(0===t.n)return t.a(2,new Promise(function(t){chrome.storage.local.get(["sessionToken"],function(n){if(n.sessionToken)t(n.sessionToken);else{var r=e.generateSessionToken();chrome.storage.local.set({sessionToken:r}),t(r)}})}))},t)})),function(){return f.apply(this,arguments)})},{key:"generateSessionToken",value:function(){return"session_"+Date.now()+"_"+Math.random().toString(36).substr(2,9)}},{key:"makeAuthenticatedRequest",value:(h=c(a().m(function t(e){var r,o,i,c,s=arguments;return a().w(function(t){for(;;)switch(t.n){case 0:return r=s.length>1&&void 0!==s[1]?s[1]:{},t.n=1,this.getAuthData();case 1:if((o=t.v).auth_token){t.n=2;break}throw new Error("Not authenticated");case 2:return i=n({"Content-Type":"application/json",Authorization:"Bearer ".concat(o.auth_token)},r.headers),t.n=3,fetch("".concat(this.baseURL).concat(e),n(n({},r),{},{headers:i}));case 3:if(401!==(c=t.v).status){t.n=5;break}return t.n=4,this.clearAuthData();case 4:throw new Error("Authentication expired");case 5:return t.a(2,c)}},t,this)})),function(t){return h.apply(this,arguments)})},{key:"sendWebsiteData",value:(u=c(a().m(function t(e){var n,r;return a().w(function(t){for(;;)switch(t.p=t.n){case 0:return t.p=0,t.n=1,this.makeAuthenticatedRequest("/websites",{method:"POST",body:JSON.stringify(e)});case 1:return n=t.v,t.n=2,n.json();case 2:return t.a(2,t.v);case 3:throw t.p=3,r=t.v,console.error("Error sending website data:",r),r;case 4:return t.a(2)}},t,this,[[0,3]])})),function(t){return u.apply(this,arguments)})},{key:"sendSessionData",value:(i=c(a().m(function t(e){var n,r;return a().w(function(t){for(;;)switch(t.p=t.n){case 0:return t.p=0,t.n=1,this.makeAuthenticatedRequest("/sessions",{method:"POST",body:JSON.stringify(e)});case 1:return n=t.v,t.n=2,n.json();case 2:return t.a(2,t.v);case 3:throw t.p=3,r=t.v,console.error("Error sending session data:",r),r;case 4:return t.a(2)}},t,this,[[0,3]])})),function(t){return i.apply(this,arguments)})},{key:"updateLastActivity",value:(o=c(a().m(function t(){var e,n,r;return a().w(function(t){for(;;)switch(t.p=t.n){case 0:return t.n=1,this.getSessionToken();case 1:return e=t.v,t.p=2,t.n=3,this.makeAuthenticatedRequest("/sessions/".concat(e),{method:"PATCH",body:JSON.stringify({last_activity:(new Date).toISOString()})});case 3:return n=t.v,t.n=4,n.json();case 4:return t.a(2,t.v);case 5:throw t.p=5,r=t.v,console.error("Error updating last activity:",r),r;case 6:return t.a(2)}},t,this,[[2,5]])})),function(){return o.apply(this,arguments)})},{key:"getWebsiteInfo",value:(r=c(a().m(function t(e){var n,r;return a().w(function(t){for(;;)switch(t.p=t.n){case 0:return t.p=0,t.n=1,this.makeAuthenticatedRequest("/websites/".concat(e));case 1:return n=t.v,t.n=2,n.json();case 2:return t.a(2,t.v);case 3:throw t.p=3,r=t.v,console.error("Error fetching website info:",r),r;case 4:return t.a(2)}},t,this,[[0,3]])})),function(t){return r.apply(this,arguments)})}],e&&s(t.prototype,e),Object.defineProperty(t,"prototype",{writable:!1}),t;var t,e,r,o,i,u,h,f,l,p,v,d,y,g}());function f(){return l.apply(this,arguments)}function l(){return(l=c(a().m(function t(){var e,n,r,o,i,c,s,u;return a().w(function(t){for(;;)switch(t.p=t.n){case 0:return t.n=1,h.getSessionToken();case 1:return n=t.v,r=h.generateBrowserFingerprint(),o=navigator.userAgent,t.n=2,v();case 2:return i=t.v,c=chrome.runtime.getManifest().version,s=(new Date).toISOString(),e={session_token:n,browser_fingerprint:r,user_agent:o,ip_address:i,extension_version:c,is_active:!0,last_activity:s},t.p=3,t.n=4,h.sendSessionData(e);case 4:console.log("Session data initialized"),t.n=6;break;case 5:t.p=5,u=t.v,console.error("Failed to initialize session:",u);case 6:return t.a(2)}},t,null,[[3,5]])}))).apply(this,arguments)}function p(){return(p=c(a().m(function t(e,n,r){return a().w(function(t){for(;;)switch(t.n){case 0:if(n){t.n=1;break}return t.a(2);case 1:return t.n=2,h.checkAuthentication();case 2:t.v.authenticated?chrome.action.setBadgeText({text:"",tabId:r}):(chrome.action.setBadgeText({text:"!",tabId:r}),chrome.action.setBadgeBackgroundColor({color:"#ff4444"}),chrome.notifications.create({type:"basic",iconUrl:"icons/icon48.png",title:"TOS & Privacy Policy Detected",message:"Terms of service or privacy policy detected on ".concat(e,". Login to track and manage this information.")}));case 3:return t.a(2)}},t)}))).apply(this,arguments)}function v(){return d.apply(this,arguments)}function d(){return(d=c(a().m(function t(){var e,n,r;return a().w(function(t){for(;;)switch(t.p=t.n){case 0:return t.p=0,t.n=1,fetch("https://api.ipify.org?format=json");case 1:return e=t.v,t.n=2,e.json();case 2:return n=t.v,t.a(2,n.ip);case 3:return t.p=3,r=t.v,console.error("Failed to get public IP:",r),t.a(2,"unknown")}},t,null,[[0,3]])}))).apply(this,arguments)}chrome.runtime.onInstalled.addListener(c(a().m(function t(){var e;return a().w(function(t){for(;;)switch(t.n){case 0:return console.log("TOS & Privacy Manager extension installed"),t.n=1,h.checkAuthentication();case 1:if(!(e=t.v).authenticated){t.n=3;break}return console.log("User is authenticated, initializing session data"),t.n=2,f();case 2:t.n=4;break;case 3:console.log("User not authenticated, reason:",e.reason);case 4:return t.a(2)}},t)}))),chrome.tabs.onUpdated.addListener(function(){var t=c(a().m(function t(e,r,o){var i,c,s;return a().w(function(t){for(;;)switch(t.p=t.n){case 0:if("complete"!==r.status||!o.url||o.url.startsWith("chrome://")){t.n=5;break}return t.n=1,h.checkAuthentication();case 1:if(t.v.authenticated){t.n=2;break}return console.log("User not authenticated, skipping data collection"),t.a(2);case 2:return t.p=2,i=new URL(o.url),c=i.hostname,t.n=3,h.updateLastActivity();case 3:chrome.tabs.sendMessage(e,{action:"getWebsiteData"},function(t){t&&t.websiteData&&(t.websiteData.tos_url||t.websiteData.privacy_policy_url)&&h.sendWebsiteData(n(n({},t.websiteData),{},{domain:c,last_crawled_at:(new Date).toISOString()})).catch(function(t){console.error("Failed to send website data:",t)})}),t.n=5;break;case 4:t.p=4,s=t.v,console.error("Error processing tab update:",s);case 5:return t.a(2)}},t,null,[[2,4]])}));return function(e,n,r){return t.apply(this,arguments)}}()),chrome.runtime.onMessage.addListener(function(t,e,n){switch(t.action){case"checkAuth":return h.checkAuthentication().then(function(t){return n(t)}).catch(function(t){return n({authenticated:!1,error:t.message})}),!0;case"redirectToLogin":return h.redirectToLogin(),n({success:!0}),!1;case"setAuthData":return h.setAuthData(t.authData).then(function(){return n({success:!0})}).catch(function(t){return n({success:!1,error:t.message})}),!0;case"clearAuth":return h.clearAuthData().then(function(){return n({success:!0})}).catch(function(t){return n({success:!1,error:t.message})}),!0;case"getWebsiteInfo":return h.checkAuthentication().then(function(e){if(e.authenticated)return h.getWebsiteInfo(t.domain);n({success:!1,error:"Not authenticated"})}).then(function(t){return n({success:!0,data:t})}).catch(function(t){return n({success:!1,error:t.message})}),!0;case"updateActivity":return h.checkAuthentication().then(function(t){if(t.authenticated)return h.updateLastActivity();n({success:!1,error:"Not authenticated"})}).then(function(){return n({success:!0})}).catch(function(t){return n({success:!1,error:t.message})}),!0;case"detectPolicy":return function(t,e,n){p.apply(this,arguments)}(t.domain,t.hasPolicy,e.tab.id),n({success:!0}),!1;default:n({success:!1,error:"Unknown action"})}})})();