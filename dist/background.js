/*! For license information please see background.js.LICENSE.txt */
(()=>{function e(t){return e="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},e(t)}function t(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),n.push.apply(n,r)}return n}function n(e){for(var n=1;n<arguments.length;n++){var a=null!=arguments[n]?arguments[n]:{};n%2?t(Object(a),!0).forEach(function(t){r(e,t,a[t])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(a)):t(Object(a)).forEach(function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(a,t))})}return e}function r(e,t,n){return(t=u(t))in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function a(){var e,t,n="function"==typeof Symbol?Symbol:{},r=n.iterator||"@@iterator",o=n.toStringTag||"@@toStringTag";function i(n,r,a,o){var i=r&&r.prototype instanceof u?r:u,h=Object.create(i.prototype);return s(h,"_invoke",function(n,r,a){var s,o,i,u=0,h=a||[],l=!1,f={p:0,n:0,v:e,a:d,f:d.bind(e,4),d:function(t,n){return s=t,o=0,i=e,f.n=n,c}};function d(n,r){for(o=n,i=r,t=0;!l&&u&&!a&&t<h.length;t++){var a,s=h[t],d=f.p,p=s[2];n>3?(a=p===r)&&(i=s[(o=s[4])?5:(o=3,3)],s[4]=s[5]=e):s[0]<=d&&((a=n<2&&d<s[1])?(o=0,f.v=r,f.n=s[1]):d<p&&(a=n<3||s[0]>r||r>p)&&(s[4]=n,s[5]=r,f.n=p,o=0))}if(a||n>1)return c;throw l=!0,r}return function(a,h,p){if(u>1)throw TypeError("Generator is already running");for(l&&1===h&&d(h,p),o=h,i=p;(t=o<2?e:i)||!l;){s||(o?o<3?(o>1&&(f.n=-1),d(o,i)):f.n=i:f.v=i);try{if(u=2,s){if(o||(a="next"),t=s[a]){if(!(t=t.call(s,i)))throw TypeError("iterator result is not an object");if(!t.done)return t;i=t.value,o<2&&(o=0)}else 1===o&&(t=s.return)&&t.call(s),o<2&&(i=TypeError("The iterator does not provide a '"+a+"' method"),o=1);s=e}else if((t=(l=f.n<0)?i:n.call(r,f))!==c)break}catch(t){s=e,o=1,i=t}finally{u=1}}return{value:t,done:l}}}(n,a,o),!0),h}var c={};function u(){}function h(){}function l(){}t=Object.getPrototypeOf;var f=[][r]?t(t([][r]())):(s(t={},r,function(){return this}),t),d=l.prototype=u.prototype=Object.create(f);function p(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,l):(e.__proto__=l,s(e,o,"GeneratorFunction")),e.prototype=Object.create(d),e}return h.prototype=l,s(d,"constructor",l),s(l,"constructor",h),h.displayName="GeneratorFunction",s(l,o,"GeneratorFunction"),s(d),s(d,o,"Generator"),s(d,r,function(){return this}),s(d,"toString",function(){return"[object Generator]"}),(a=function(){return{w:i,m:p}})()}function s(e,t,n,r){var a=Object.defineProperty;try{a({},"",{})}catch(e){a=0}s=function(e,t,n,r){function o(t,n){s(e,t,function(e){return this._invoke(t,n,e)})}t?a?a(e,t,{value:n,enumerable:!r,configurable:!r,writable:!r}):e[t]=n:(o("next",0),o("throw",1),o("return",2))},s(e,t,n,r)}function o(e,t,n,r,a,s,o){try{var i=e[s](o),c=i.value}catch(e){return void n(e)}i.done?t(c):Promise.resolve(c).then(r,a)}function i(e){return function(){var t=this,n=arguments;return new Promise(function(r,a){var s=e.apply(t,n);function i(e){o(s,r,a,i,c,"next",e)}function c(e){o(s,r,a,i,c,"throw",e)}i(void 0)})}}function c(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,u(r.key),r)}}function u(t){var n=function(t){if("object"!=e(t)||!t)return t;var n=t[Symbol.toPrimitive];if(void 0!==n){var r=n.call(t,"string");if("object"!=e(r))return r;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(t)}(t);return"symbol"==e(n)?n:n+""}var h=new(function(){return e=function e(t,n){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.baseURL=t||"http://localhost:4000/api/extension",this.authURL=n||"http://localhost:4000",this.sessionValidationInterval=null,this.VALIDATION_INTERVAL=3e5,this.authCheckInProgress=!1,this.authCheckQueue=[]},t=[{key:"checkAuthentication",value:(T=i(a().m(function e(){var t,n=this;return a().w(function(e){for(;;)switch(e.p=e.n){case 0:if(!this.authCheckInProgress){e.n=1;break}return console.log("Auth check already in progress, waiting..."),e.a(2,new Promise(function(e){n.authCheckQueue.push(e)}));case 1:return this.authCheckInProgress=!0,console.log("=== checkAuthentication called ==="),e.p=2,e.n=3,this._performAuthCheck();case 3:for(t=e.v;this.authCheckQueue.length>0;)this.authCheckQueue.shift()(t);return e.a(2,t);case 4:return e.p=4,this.authCheckInProgress=!1,e.f(4);case 5:return e.a(2)}},e,this,[[2,,4,5]])})),function(){return T.apply(this,arguments)})},{key:"_performAuthCheck",value:(O=i(a().m(function e(){var t,r,s,o,i,c,u,h,l,f,d;return a().w(function(e){for(;;)switch(e.p=e.n){case 0:return e.n=1,this.getAuthData();case 1:if(t=e.v,console.log("checkAuthentication - starting with authData:",t),r=!!t.auth_token,s=!!t.expires_at,o=s&&new Date(t.expires_at)>new Date,console.log("Token check - hasToken:",r,"hasExpiration:",s,"isNotExpired:",o),console.log("Expiration date:",t.expires_at,"Current date:",(new Date).toISOString()),!(r&&s&&o)){e.n=2;break}return console.log("Using cached authentication data"),this.validateOrCreateBrowserSession(),e.a(2,{authenticated:!0,user:t.user_id});case 2:if(t.auth_token&&!(t.expires_at&&new Date(t.expires_at)<=new Date)){e.n=31;break}return console.log("Checking authentication with server"),e.p=3,e.n=4,fetch("".concat(this.baseURL,"/is_authenticated"),{method:"GET",credentials:"include",headers:n(n({},t.auth_token&&{Authorization:"Bearer ".concat(t.auth_token)}),{},{"Content-Type":"application/json"})});case 4:if(!(i=e.v).ok){e.n=26;break}return e.n=5,i.json();case 5:if(c=e.v,console.log("Auth check result:",c),!c.authenticated){e.n=22;break}if(t.auth_token){e.n=18;break}return console.log("User authenticated but no token data, fetching auth data"),e.p=6,e.n=7,fetch("".concat(this.baseURL,"/auth_data"),{method:"GET",credentials:"include",headers:{"Content-Type":"application/json"}});case 7:if(!(u=e.v).ok){e.n=14;break}return e.n=8,u.json();case 8:return h=e.v,console.log("Fetched auth data:",h),e.p=9,e.n=10,this.setAuthData({auth_token:h.auth_token,user_id:h.user_id,expires_at:h.expires_at,username:h.username,is_authenticated:!0,last_check:(new Date).toISOString()});case 10:console.log("Auth data successfully saved to storage"),e.n=12;break;case 11:return e.p=11,l=e.v,console.error("Failed to save auth data:",l),e.a(2,{authenticated:!1,reason:"storage_error"});case 12:return e.n=13,this.validateOrCreateBrowserSession();case 13:case 20:return e.a(2,{authenticated:!0,user:c.user});case 14:return console.error("Failed to fetch auth data:",u.status),e.a(2,{authenticated:!1,reason:"server_error"});case 15:e.n=17;break;case 16:return e.p=16,f=e.v,console.error("Error fetching auth data:",f),e.a(2,{authenticated:!1,reason:"network_error"});case 17:e.n=21;break;case 18:return e.n=19,this.updateAuthData({last_check:(new Date).toISOString()});case 19:return e.n=20,this.validateOrCreateBrowserSession();case 21:e.n=25;break;case 22:return e.n=23,this.clearAuthData();case 23:return e.n=24,this.clearSessionData();case 24:return e.a(2,{authenticated:!1,reason:"invalid_token"});case 25:e.n=29;break;case 26:return e.n=27,this.clearAuthData();case 27:return e.n=28,this.clearSessionData();case 28:return e.a(2,{authenticated:!1,reason:"server_error"});case 29:e.n=31;break;case 30:return e.p=30,d=e.v,console.error("Authentication check failed:",d),e.a(2,{authenticated:!1,reason:"network_error"});case 31:return e.a(2,{authenticated:!1,reason:"unknown"})}},e,this,[[9,11],[6,16],[3,30]])})),function(){return O.apply(this,arguments)})},{key:"validateOrCreateBrowserSession",value:(D=i(a().m(function e(){var t,n,r,s;return a().w(function(e){for(;;)switch(e.p=e.n){case 0:return e.p=0,e.n=1,this.getBrowserSessionData();case 1:return t=e.v,e.n=2,this.makeAuthenticatedRequest("/sessions/validate",{method:"POST",body:JSON.stringify(t)});case 2:if(!(n=e.v).ok){e.n=8;break}return e.n=3,n.json();case 3:if(r=e.v,console.log("Browser session validated/created:",r.session_token),!n.authenticated){e.n=5;break}return e.n=4,this.updateBrowserSessionData({authenticated:!0,session_token:r.session_token,created_at:r.inserted_at,last_activity:r.last_activity,is_active:r.is_active,user_agent:r.user_agent,ip_address:r.ip_address,extension_version:r.extension_version,browser_fingerprint:r.browser_fingerprint});case 4:return e.a(2,r.data);case 5:return e.n=6,this.clearSessionData();case 6:return this.clearAuthData(),e.a(2,null);case 7:e.n=9;break;case 8:return console.error("Failed to validate browser session:",n.status),e.a(2,null);case 9:e.n=11;break;case 10:return e.p=10,s=e.v,console.error("Error validating browser session:",s),e.a(2,null);case 11:return e.a(2)}},e,this,[[0,10]])})),function(){return D.apply(this,arguments)})},{key:"getBrowserSessionData",value:(A=i(a().m(function e(){var t,r,s,o,i,c,u,h;return a().w(function(e){for(;;)switch(e.n){case 0:return e.n=1,this.getSessionToken();case 1:return t=e.v,e.n=2,this.getStoredSessionData();case 2:return r=e.v,s=n,o=t,i=this.generateBrowserFingerprint(),c=navigator.userAgent,e.n=3,f();case 3:return u=e.v,h=chrome.runtime.getManifest().version,e.a(2,s({session_token:o,browser_fingerprint:i,user_agent:c,ip_address:u,extension_version:h},r))}},e,this)})),function(){return A.apply(this,arguments)})},{key:"getStoredSessionData",value:(_=i(a().m(function e(){return a().w(function(e){for(;;)if(0===e.n)return e.a(2,new Promise(function(e){chrome.storage.local.get(["browserSessionData"],function(t){e(t.browserSessionData||{})})}))},e)})),function(){return _.apply(this,arguments)})},{key:"updateBrowserSessionData",value:(S=i(a().m(function e(t){var r,s;return a().w(function(e){for(;;)switch(e.n){case 0:return e.n=1,this.getStoredSessionData();case 1:return r=e.v,s=n(n({},r),t),e.a(2,new Promise(function(e){chrome.storage.local.set({browserSessionData:s},e)}))}},e,this)})),function(e){return S.apply(this,arguments)})},{key:"clearSessionData",value:(b=i(a().m(function e(){return a().w(function(e){for(;;)if(0===e.n)return e.a(2,new Promise(function(e){chrome.storage.local.remove(["sessionToken","browserSessionData"],e)}))},e)})),function(){return b.apply(this,arguments)})},{key:"updateLastActivity",value:(w=i(a().m(function e(){var t,n,r;return a().w(function(e){for(;;)switch(e.p=e.n){case 0:return e.n=1,this.getSessionToken();case 1:return t=e.v,e.p=2,e.n=3,this.makeAuthenticatedRequest("/sessions/".concat(t,"/activity"),{method:"PATCH",body:JSON.stringify({last_activity:(new Date).toISOString()})});case 3:if(!(n=e.v).ok){e.n=4;break}return console.log("Activity updated successfully"),e.n=4,this.updateBrowserSessionData({last_activity_update:(new Date).toISOString()});case 4:return e.n=5,n.json();case 5:return e.a(2,e.v);case 6:throw e.p=6,r=e.v,console.error("Error updating last activity:",r),r;case 7:return e.a(2)}},e,this,[[2,6]])})),function(){return w.apply(this,arguments)})},{key:"startSessionValidation",value:function(){var e=this;this.sessionValidationInterval&&clearInterval(this.sessionValidationInterval),this.sessionValidationInterval=setInterval(i(a().m(function t(){return a().w(function(t){for(;;)switch(t.n){case 0:return t.n=1,e.checkAuthentication();case 1:t.v.authenticated||(console.log("Session validation failed, stopping scheduler"),e.stopSessionValidation());case 2:return t.a(2)}},t)})),this.VALIDATION_INTERVAL)}},{key:"stopSessionValidation",value:function(){this.sessionValidationInterval&&(clearInterval(this.sessionValidationInterval),this.sessionValidationInterval=null)}},{key:"logout",value:(k=i(a().m(function e(){var t,n;return a().w(function(e){for(;;)switch(e.p=e.n){case 0:return e.n=1,this.getSessionToken();case 1:return t=e.v,e.p=2,e.n=3,this.makeAuthenticatedRequest("/sessions/".concat(t),{method:"DELETE"});case 3:e.n=5;break;case 4:e.p=4,n=e.v,console.error("Error deactivating session:",n);case 5:return e.n=6,this.clearAuthData();case 6:return e.n=7,this.clearSessionData();case 7:this.stopSessionValidation();case 8:return e.a(2)}},e,this,[[2,4]])})),function(){return k.apply(this,arguments)})},{key:"getAuthData",value:(y=i(a().m(function e(){return a().w(function(e){for(;;)if(0===e.n)return e.a(2,new Promise(function(e){chrome.storage.local.get(["authData"],function(t){console.log("getAuthData - raw result from storage:",t);var n=t.authData||{auth_token:"",user_id:"",expires_at:"",is_authenticated:!1,last_check:"",username:""};console.log("getAuthData - returning:",n),e(n)})}))},e)})),function(){return y.apply(this,arguments)})},{key:"setAuthData",value:(m=i(a().m(function e(t){var n=this;return a().w(function(e){for(;;)if(0===e.n)return e.a(2,new Promise(function(e,r){console.log("About to save auth data:",t),chrome.storage.local.set({authData:t},function(){if(chrome.runtime.lastError)return console.error("Error saving auth data:",chrome.runtime.lastError),void r(chrome.runtime.lastError);console.log("Auth data saved successfully"),chrome.storage.local.get(["authData"],function(e){console.log("Verification - saved auth data:",e.authData)}),t.auth_token&&n.startSessionValidation(),e()})}))},e)})),function(e){return m.apply(this,arguments)})},{key:"updateAuthData",value:(g=i(a().m(function e(t){var r,s;return a().w(function(e){for(;;)switch(e.n){case 0:return e.n=1,this.getAuthData();case 1:return r=e.v,s=n(n({},r),t),e.n=2,this.setAuthData(s);case 2:return e.a(2,s)}},e,this)})),function(e){return g.apply(this,arguments)})},{key:"clearAuthData",value:(v=i(a().m(function e(){return a().w(function(e){for(;;)if(0===e.n)return this.stopSessionValidation(),e.a(2,new Promise(function(e){chrome.storage.local.remove(["authData"],e)}))},e,this)})),function(){return v.apply(this,arguments)})},{key:"redirectToLogin",value:(p=i(a().m(function e(){return a().w(function(e){for(;;)switch(e.n){case 0:chrome.tabs.create({url:"".concat(this.authURL,"/users/log_in")});case 1:return e.a(2)}},e,this)})),function(){return p.apply(this,arguments)})},{key:"generateBrowserFingerprint",value:function(){var e={userAgent:navigator.userAgent,language:navigator.language,platform:navigator.platform,timezone:Intl.DateTimeFormat().resolvedOptions().timeZone,extensionId:chrome.runtime.id,serviceWorkerContext:!0};return btoa(JSON.stringify(e))}},{key:"getSessionToken",value:(d=i(a().m(function e(){var t=this;return a().w(function(e){for(;;)if(0===e.n)return e.a(2,new Promise(function(e){chrome.storage.local.get(["sessionToken"],function(n){if(n.sessionToken)e(n.sessionToken);else{var r=t.generateSessionToken();chrome.storage.local.set({sessionToken:r}),e(r)}})}))},e)})),function(){return d.apply(this,arguments)})},{key:"generateSessionToken",value:function(){return"ext_session_"+Date.now()+"_"+Math.random().toString(36).substr(2,12)}},{key:"makeAuthenticatedRequest",value:(l=i(a().m(function e(t){var r,s,o,i,c=arguments;return a().w(function(e){for(;;)switch(e.n){case 0:return r=c.length>1&&void 0!==c[1]?c[1]:{},e.n=1,this.getAuthData();case 1:if((s=e.v).auth_token){e.n=2;break}throw console.log(s.auth_token),new Error("Not authenticated");case 2:return o=n({"Content-Type":"application/json",Authorization:"Bearer ".concat(s.auth_token)},r.headers),e.n=3,fetch("".concat(this.baseURL).concat(t),n(n({},r),{},{headers:o}));case 3:if(401!==(i=e.v).status){e.n=6;break}return e.n=4,this.clearAuthData();case 4:return e.n=5,this.clearSessionData();case 5:throw new Error("Authentication expired");case 6:return e.a(2,i)}},e,this)})),function(e){return l.apply(this,arguments)})},{key:"sendWebsiteData",value:(h=i(a().m(function e(t){var n,r;return a().w(function(e){for(;;)switch(e.p=e.n){case 0:return e.p=0,e.n=1,this.makeAuthenticatedRequest("/sites",{method:"POST",body:JSON.stringify(t)});case 1:return n=e.v,e.n=2,n.json();case 2:return e.a(2,e.v);case 3:throw e.p=3,r=e.v,console.error("Error sending website data:",r),r;case 4:return e.a(2)}},e,this,[[0,3]])})),function(e){return h.apply(this,arguments)})},{key:"siteAvailable",value:(u=i(a().m(function e(t){var n,r;return a().w(function(e){for(;;)switch(e.p=e.n){case 0:return e.p=0,e.n=1,this.makeAuthenticatedRequest("/sites/".concat(t,"/available"));case 1:return n=e.v,e.n=2,n.json();case 2:return e.a(2,e.v);case 3:throw e.p=3,r=e.v,console.error("Error checking site availability:",r),r;case 4:return e.a(2)}},e,this,[[0,3]])})),function(e){return u.apply(this,arguments)})},{key:"getWebsiteInfo",value:(o=i(a().m(function e(t){var n,r,s,o=arguments;return a().w(function(e){for(;;)switch(e.p=e.n){case 0:return n=o.length>1&&void 0!==o[1]?o[1]:null,e.p=1,e.n=2,this.makeAuthenticatedRequest("/sites/".concat(t),{method:"POST",body:JSON.stringify(n||{domain:t})});case 2:return r=e.v,e.n=3,r.json();case 3:return e.a(2,e.v);case 4:throw e.p=4,s=e.v,console.error("Error fetching website info:",s),s;case 5:return e.a(2)}},e,this,[[1,4]])})),function(e){return o.apply(this,arguments)})},{key:"getUserSessions",value:(s=i(a().m(function e(){var t,n;return a().w(function(e){for(;;)switch(e.p=e.n){case 0:return e.p=0,e.n=1,this.makeAuthenticatedRequest("/sessions");case 1:return t=e.v,e.n=2,t.json();case 2:return e.a(2,e.v);case 3:throw e.p=3,n=e.v,console.error("Error fetching user sessions:",n),n;case 4:return e.a(2)}},e,this,[[0,3]])})),function(){return s.apply(this,arguments)})},{key:"deactivateOtherSessions",value:(r=i(a().m(function e(){var t,n,r;return a().w(function(e){for(;;)switch(e.p=e.n){case 0:return e.n=1,this.getSessionToken();case 1:return t=e.v,e.p=2,e.n=3,this.makeAuthenticatedRequest("/sessions/".concat(t,"/deactivate_others"),{method:"POST"});case 3:return n=e.v,e.n=4,n.json();case 4:return e.a(2,e.v);case 5:throw e.p=5,r=e.v,console.error("Error deactivating other sessions:",r),r;case 6:return e.a(2)}},e,this,[[2,5]])})),function(){return r.apply(this,arguments)})}],t&&c(e.prototype,t),Object.defineProperty(e,"prototype",{writable:!1}),e;var e,t,r,s,o,u,h,l,d,p,v,g,m,y,k,w,b,S,_,A,D,O,T}());function l(){return(l=i(a().m(function e(t,n,r){return a().w(function(e){for(;;)switch(e.n){case 0:if(n){e.n=1;break}return e.a(2);case 1:return e.n=2,h.checkAuthentication();case 2:e.v.authenticated?chrome.action.setBadgeText({text:"",tabId:r}):(chrome.action.setBadgeText({text:"!",tabId:r}),chrome.action.setBadgeBackgroundColor({color:"#ff4444"}),chrome.notifications.create({type:"basic",iconUrl:"icons/icon48.png",title:"TOS & Privacy Policy Detected",message:"Terms of service or privacy policy detected on ".concat(t,". Login to track and manage this information.")}));case 3:return e.a(2)}},e)}))).apply(this,arguments)}function f(){return d.apply(this,arguments)}function d(){return(d=i(a().m(function e(){var t,n,r;return a().w(function(e){for(;;)switch(e.p=e.n){case 0:return e.p=0,e.n=1,fetch("https://api.ipify.org?format=json");case 1:return t=e.v,e.n=2,t.json();case 2:return n=e.v,e.a(2,n.ip);case 3:return e.p=3,r=e.v,console.error("Failed to get public IP:",r),e.a(2,"unknown")}},e,null,[[0,3]])}))).apply(this,arguments)}chrome.runtime.onInstalled.addListener(i(a().m(function e(){var t;return a().w(function(e){for(;;)switch(e.n){case 0:return console.log("TOS & Privacy Manager extension installed"),e.n=1,h.checkAuthentication();case 1:(t=e.v).authenticated?(console.log("User is authenticated, initializing session management"),h.startSessionValidation()):console.log("User not authenticated, reason:",t.reason);case 2:return e.a(2)}},e)}))),chrome.runtime.onStartup.addListener(i(a().m(function e(){return a().w(function(e){for(;;)switch(e.n){case 0:return e.n=1,h.checkAuthentication();case 1:e.v.authenticated&&h.startSessionValidation();case 2:return e.a(2)}},e)}))),chrome.tabs.onUpdated.addListener(function(){var e=i(a().m(function e(t,r,s){var o,i,c;return a().w(function(e){for(;;)switch(e.p=e.n){case 0:if("complete"!==r.status||!s.url||s.url.startsWith("chrome://")){e.n=5;break}return e.n=1,h.checkAuthentication();case 1:if(e.v.authenticated){e.n=2;break}return console.log("User not authenticated, skipping data collection"),e.a(2);case 2:return e.p=2,o=new URL(s.url),i=o.hostname,e.n=3,h.updateLastActivity();case 3:chrome.tabs.sendMessage(t,{action:"getWebsiteData"},function(e){e&&e.websiteData&&(e.websiteData.tos_url||e.websiteData.privacy_policy_url)&&h.sendWebsiteData(n(n({},e.websiteData),{},{domain:i,last_crawled_at:(new Date).toISOString()})).catch(function(e){console.error("Failed to send website data:",e)})}),e.n=5;break;case 4:e.p=4,c=e.v,console.error("Error processing tab update:",c);case 5:return e.a(2)}},e,null,[[2,4]])}));return function(t,n,r){return e.apply(this,arguments)}}()),chrome.runtime.onMessage.addListener(function(e,t,n){switch(e.action){case"checkAuth":return h.checkAuthentication().then(function(e){return n(e)}).catch(function(e){return n({authenticated:!1,error:e.message})}),!0;case"redirectToLogin":return h.redirectToLogin(),n({success:!0}),!1;case"setAuthData":return h.setAuthData(e.authData).then(function(){return n({success:!0})}).catch(function(e){return n({success:!1,error:e.message})}),!0;case"clearAuth":return h.logout().then(function(){return n({success:!0})}).catch(function(e){return n({success:!1,error:e.message})}),!0;case"siteAvailable":return h.checkAuthentication().then(function(t){if(t.authenticated)return h.siteAvailable(e.domain);n({success:!1,error:"Not authenticated"})}).then(function(e){return n({success:!0,data:e})}).catch(function(e){return n({success:!1,error:e.message})}),!0;case"getWebsiteInfo":return h.checkAuthentication().then(function(t){if(t.authenticated)return h.getWebsiteInfo(e.domain,e.websiteData);n({success:!1,error:"Not authenticated"})}).then(function(e){return n({success:!0,data:e})}).catch(function(e){return n({success:!1,error:e.message})}),!0;case"updateActivity":return h.checkAuthentication().then(function(e){if(e.authenticated)return h.updateLastActivity();n({success:!1,error:"Not authenticated"})}).then(function(){return n({success:!0})}).catch(function(e){return n({success:!1,error:e.message})}),!0;case"getUserSessions":return h.checkAuthentication().then(function(e){if(e.authenticated)return h.getUserSessions();n({success:!1,error:"Not authenticated"})}).then(function(e){return n({success:!0,data:e})}).catch(function(e){return n({success:!1,error:e.message})}),!0;case"deactivateOtherSessions":return h.checkAuthentication().then(function(e){if(e.authenticated)return h.deactivateOtherSessions();n({success:!1,error:"Not authenticated"})}).then(function(e){return n({success:!0,data:e})}).catch(function(e){return n({success:!1,error:e.message})}),!0;case"validateBrowserSession":return h.checkAuthentication().then(function(e){if(e.authenticated)return h.validateOrCreateBrowserSession();n({success:!1,error:"Not authenticated"})}).then(function(e){return n({success:!0,data:e})}).catch(function(e){return n({success:!1,error:e.message})}),!0;case"detectPolicy":return function(e,t,n){l.apply(this,arguments)}(e.domain,e.hasPolicy,t.tab.id),n({success:!0}),!1;case"getBrowserSessionInfo":return h.getBrowserSessionData().then(function(e){return n({success:!0,data:e})}).catch(function(e){return n({success:!1,error:e.message})}),!0;default:n({success:!1,error:"Unknown action"})}}),setInterval(function(){h.checkAuthentication().then(function(e){e.authenticated||h.stopSessionValidation()})},18e5)})();